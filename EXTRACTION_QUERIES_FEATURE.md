# Implementation Summary: LLM Queries and Textract Responses Storage

## Overview
This implementation adds database storage for LLM-generated extraction queries and AWS Textract responses with confidence scores. The data is now persisted and accessible through updated API endpoints.

## Changes Made

### 1. Database Schema

#### New Table: `policy_extraction_queries`
Created a new table to store extraction queries and responses:

**Columns:**
- `id` (SERIAL PRIMARY KEY)
- `bank_id` (VARCHAR(50)) - Foreign key to banks table
- `policy_type_id` (VARCHAR(50)) - Foreign key to policy_types table
- `query_text` (TEXT) - The query generated by LLM
- `response_text` (TEXT) - The response from Textract
- `confidence_score` (NUMERIC(5,2)) - Textract confidence score (0-100)
- `document_hash` (VARCHAR(64)) - SHA-256 hash of source document
- `source_document` (VARCHAR(500)) - S3 URL or document path
- `extraction_method` (VARCHAR(50)) - Defaults to 'textract'
- `query_order` (INTEGER) - Order in which query was generated
- `is_active` (BOOLEAN) - Defaults to true
- `created_at`, `updated_at` (TIMESTAMP)

**Indexes:**
- `idx_extraction_queries_bank_policy` - On (bank_id, policy_type_id)
- `idx_extraction_queries_document_hash` - On document_hash
- `idx_extraction_queries_active` - On is_active
- `idx_extraction_queries_created_at` - On created_at
- `idx_extraction_queries_confidence` - On confidence_score (partial index)

**Files Modified:**
- `rule-agent/db/init.sql` - Added table definition
- `db/migrations/002_create_policy_extraction_queries_table.sql` - Migration file
- `db/migrations/002_rollback_policy_extraction_queries_table.sql` - Rollback file

### 2. DatabaseService.py Updates

#### New SQLAlchemy Model
Added `PolicyExtractionQuery` class with proper relationships to Bank and PolicyType models.

#### New Methods
1. **`save_extraction_queries(bank_id, policy_type_id, queries_data, document_hash, source_document)`**
   - Saves LLM queries and Textract responses to database
   - Deactivates old queries for same bank/policy/document combination
   - Returns list of created query IDs

2. **`get_extraction_queries(bank_id, policy_type_id, document_hash=None, active_only=True)`**
   - Retrieves extraction queries for a bank and policy type
   - Optional filtering by document hash
   - Returns ordered list of queries with all metadata including confidence scores

3. **`delete_extraction_queries(bank_id, policy_type_id, document_hash=None)`**
   - Deletes queries for bank/policy combination
   - Optional document-specific deletion

**Location:** [DatabaseService.py:220-254](rule-agent/DatabaseService.py#L220-L254) (Model)
**Location:** [DatabaseService.py:713-841](rule-agent/DatabaseService.py#L713-L841) (Methods)

### 3. UnderwritingWorkflow.py Updates

Added **Step 3.5** in the workflow to save extraction queries immediately after Textract extraction:

**Implementation:**
- Extracts queries and responses from Textract output
- Formats data with query text, response text, and confidence scores
- Calls `db_service.save_extraction_queries()` to persist data
- Logs success/failure in workflow result

**Code Changes:**
- Added between Step 3 (data extraction) and Step 4 (rule generation)
- Properly handles Textract response format: `extracted_data['queries'][query_text]`
- Extracts confidence scores from Textract: `query_info.get('confidence', None)`

**Location:** [UnderwritingWorkflow.py:169-210](rule-agent/UnderwritingWorkflow.py#L169-L210)

### 4. ChatService.py API Updates

#### Updated Endpoint: `GET /rule-agent/api/v1/policies`
Enhanced to include extraction queries and rules based on query parameters.

**New Query Parameters:**
- `include_queries` (boolean) - Include extraction queries in response
- `include_rules` (boolean) - Include extracted rules in response

**Response Format:**
```json
{
    "status": "success",
    "container": {
        "container_id": "...",
        "bank_id": "...",
        "policy_type_id": "...",
        "endpoint": "...",
        "status": "...",
        "health_status": "...",
        "deployed_at": "..."
    },
    "extraction_queries": [
        {
            "id": 1,
            "query_text": "What is the maximum coverage amount?",
            "response_text": "$1,000,000",
            "confidence_score": 95.5,
            "document_hash": "abc123...",
            "source_document": "s3://...",
            "extraction_method": "textract",
            "query_order": 1,
            "is_active": true,
            "created_at": "2025-11-12T...",
            "updated_at": "2025-11-12T..."
        }
    ],
    "extraction_queries_count": 20,
    "extracted_rules": [...],
    "extracted_rules_count": 15
}
```

**Location:** [ChatService.py:600-666](rule-agent/ChatService.py#L600-L666)

#### Updated Endpoint: `GET /rule-agent/api/v1/banks/<bank_id>/policies`
Enhanced to include extraction queries and rules for each policy.

**New Query Parameters:**
- `include_queries` (boolean) - Include extraction queries count
- `include_rules` (boolean) - Include extracted rules count
- `details` (boolean) - Include full details with queries and rules

**Response Format:**
```json
{
    "status": "success",
    "bank_id": "chase",
    "total_policies": 2,
    "policies": [
        {
            "policy_type_id": "life_insurance",
            "policy_name": "Life Insurance",
            "description": "...",
            "category": "insurance",
            "extraction_queries_count": 20,
            "extracted_rules_count": 15,
            "extraction_queries": [...],  // Only if details=true
            "extracted_rules": [...]      // Only if details=true
        }
    ]
}
```

**Location:** [ChatService.py:566-631](rule-agent/ChatService.py#L566-L631)

## Data Flow

### During Policy Processing
1. **PDF Upload** → S3
2. **Text Extraction** → PyPDF2 reads document
3. **LLM Analysis** → PolicyAnalyzerAgent generates queries
4. **AWS Textract** → Extracts answers with confidence scores
5. **✨ NEW: Save to DB** → Queries + responses + confidence scores saved
6. **Rule Generation** → RuleGeneratorAgent creates DRL
7. **Save Rules to DB** → Extracted rules saved
8. **Deployment** → Drools KIE Server

### During API Access
1. Client calls `/api/v1/policies?bank_id=X&policy_type=Y&include_queries=true`
2. System retrieves active container
3. **✨ NEW:** System retrieves extraction queries with confidence scores
4. System retrieves extracted rules
5. Returns comprehensive response with all data

## Migration Instructions

### For New Deployments
The `init.sql` script already includes the new table. No manual steps needed.

### For Existing Deployments

#### Option 1: Run Migration SQL Manually
```bash
psql -U underwriting_user -d underwriting_db -f db/migrations/002_create_policy_extraction_queries_table.sql
```

#### Option 2: Restart PostgreSQL Container
```bash
docker-compose down postgres
docker-compose up -d postgres
```

The init.sql will create the table if it doesn't exist.

#### Option 3: Use psql in Docker
```bash
docker-compose exec postgres psql -U underwriting_user -d underwriting_db
```
Then paste the contents of `002_create_policy_extraction_queries_table.sql`.

### Rollback (if needed)
```bash
psql -U underwriting_user -d underwriting_db -f db/migrations/002_rollback_policy_extraction_queries_table.sql
```

## Testing

### Test Database Setup
```bash
# Check if table exists
docker-compose exec postgres psql -U underwriting_user -d underwriting_db -c "\dt policy_extraction_queries"

# Verify schema
docker-compose exec postgres psql -U underwriting_user -d underwriting_db -c "\d policy_extraction_queries"
```

### Test API Endpoints

#### Test 1: Process a policy and verify queries are saved
```bash
# Upload and process a policy
curl -X POST http://localhost:9000/rule-agent/process_policy_from_s3 \
  -H "Content-Type: application/json" \
  -d '{
    "s3_url": "s3://your-bucket/policy.pdf",
    "policy_type": "life_insurance",
    "bank_id": "chase"
  }'

# Check the workflow result includes "save_extraction_queries" step
```

#### Test 2: Retrieve queries via API
```bash
# Get policy with queries
curl "http://localhost:9000/rule-agent/api/v1/policies?bank_id=chase&policy_type=life_insurance&include_queries=true&include_rules=true"

# Get all bank policies with counts
curl "http://localhost:9000/rule-agent/api/v1/banks/chase/policies?include_queries=true&include_rules=true"

# Get all bank policies with full details
curl "http://localhost:9000/rule-agent/api/v1/banks/chase/policies?details=true"
```

#### Test 3: Verify data in database
```bash
docker-compose exec postgres psql -U underwriting_user -d underwriting_db -c "SELECT bank_id, policy_type_id, query_text, confidence_score FROM policy_extraction_queries LIMIT 5;"
```

### Expected Results
1. Queries are saved during policy processing (Step 3.5)
2. Confidence scores are properly stored (0-100 range)
3. API returns queries ordered by `query_order`
4. Queries include all metadata (document hash, source, timestamps)
5. Old queries are deactivated when new version is processed

## Benefits

1. **Transparency**: Users can see exactly what queries were used for extraction
2. **Audit Trail**: Complete history of extraction process with confidence scores
3. **Quality Monitoring**: Confidence scores allow quality assessment
4. **Debugging**: Easy to identify low-confidence extractions
5. **Reprocessing**: Can review and potentially re-run extractions
6. **API Flexibility**: Optional inclusion via query parameters (backward compatible)

## Notes

- The implementation is backward compatible - queries/rules are only returned when requested
- Confidence scores are stored as NUMERIC(5,2) allowing values like 95.75
- The `is_active` flag allows for versioning without deletion
- Queries are automatically deactivated when a new version is processed for the same document
- The `document_hash` links queries to specific policy versions

## Files Modified

1. ✅ `rule-agent/db/init.sql` - Added table definition
2. ✅ `db/migrations/002_create_policy_extraction_queries_table.sql` - Migration
3. ✅ `db/migrations/002_rollback_policy_extraction_queries_table.sql` - Rollback
4. ✅ `rule-agent/DatabaseService.py` - Added model and methods
5. ✅ `rule-agent/UnderwritingWorkflow.py` - Added Step 3.5 to save queries
6. ✅ `rule-agent/ChatService.py` - Updated API endpoints
7. ✅ `rule-agent/swagger.yaml` - Updated OpenAPI documentation to v2.1.0

## Swagger/OpenAPI Documentation Updates

The API documentation has been updated to reflect the new features:

### Version Update
- Updated from `v2.0.0` to `v2.1.0`
- Added "What's New in v2.1" section highlighting extraction query features

### Updated Endpoints

**1. GET /api/v1/banks/{bank_id}/policies**
- New query parameters: `include_queries`, `include_rules`, `details`
- Enhanced response schema with counts and optional full data
- Complete examples showing usage

**2. GET /api/v1/policies**
- New query parameters: `include_queries`, `include_rules`
- Enhanced response with extraction queries and confidence scores
- Two response examples: basic and with-queries-and-rules

**3. POST /process_policy_from_s3**
- Updated workflow description to include Step 3.5

### New Schema Component

**ExtractionQuery Schema:**
```yaml
ExtractionQuery:
  type: object
  properties:
    id: integer
    query_text: string
    response_text: string
    confidence_score: number (0-100)
    document_hash: string
    source_document: string
    extraction_method: enum [textract, manual]
    query_order: integer
    is_active: boolean
    created_at: datetime
    updated_at: datetime
```

### Accessing the Documentation

Once the backend is running:
- Swagger UI: http://localhost:9000/rule-agent/docs
- OpenAPI Spec: http://localhost:9000/rule-agent/swagger.yaml

## Verification Status

✅ All Python files compile without syntax errors
✅ Database schema is consistent
✅ API endpoints are backward compatible
✅ Migration files are ready for deployment
✅ Swagger documentation updated to v2.1.0
✅ New ExtractionQuery schema defined
✅ All endpoint examples include extraction queries

## Next Steps for Deployment

1. Back up the database
2. Run the migration SQL or restart postgres container
3. Restart the backend service
4. Test the API endpoints
5. Process a test policy document to verify end-to-end flow
6. Monitor logs for "Step 3.5: Saving extraction queries" message
