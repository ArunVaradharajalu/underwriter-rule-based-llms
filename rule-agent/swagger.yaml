openapi: 3.0.3
info:
  title: Underwriting Rule Engine API
  description: |
    AI-powered underwriting system with PostgreSQL-backed rule engine management.

    **Key Features:**
    - Process policy documents from S3 and generate Drools rules automatically
    - PostgreSQL database for persistent container registry
    - Customer-facing API for dynamic service discovery
    - Evaluate applications without knowing container details
    - Multi-tenant isolation with separate containers per bank+policy
    - Request tracking and analytics

    **Architecture:**
    - Customer apps query by `bank_id` + `policy_type`
    - System automatically routes to correct rule engine container
    - All requests logged to database for analytics
    - Health checking ensures high availability

  version: 2.0.0
  contact:
    name: IBM Automation
    url: https://github.com/DecisionsDev

servers:
  - url: http://localhost:9000/rule-agent
    description: Local development server

tags:
  - name: Underwriting Workflow
    description: Policy document processing and rule generation
  - name: File Management
    description: File upload and storage operations

paths:
  # ============================================================================
  # CUSTOMER-FACING API
  # ============================================================================

  /api/v1/banks:
    get:
      tags:
        - Customer API
      summary: List all available banks
      description: Discover which banks/organizations have deployed rule engines
      operationId: listBanks
      responses:
        '200':
          description: List of active banks
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  banks:
                    type: array
                    items:
                      type: object
                      properties:
                        bank_id:
                          type: string
                          example: chase
                        bank_name:
                          type: string
                          example: Chase Bank
                        description:
                          type: string
                          example: Chase Manhattan Bank underwriting policies

  /api/v1/banks/{bank_id}/policies:
    get:
      tags:
        - Customer API
      summary: List available policies for a bank
      description: Get all policy types available for a specific bank
      operationId: listBankPolicies
      parameters:
        - name: bank_id
          in: path
          required: true
          schema:
            type: string
          example: chase
      responses:
        '200':
          description: List of available policies
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  bank_id:
                    type: string
                    example: chase
                  policies:
                    type: array
                    items:
                      type: object
                      properties:
                        policy_type_id:
                          type: string
                          example: insurance
                        policy_name:
                          type: string
                          example: Insurance Underwriting
                        description:
                          type: string
                        category:
                          type: string
                          example: insurance

  /api/v1/policies:
    get:
      tags:
        - Customer API
      summary: Query specific policy container
      description: Check if rules are deployed for a specific bank+policy combination
      operationId: queryPolicies
      parameters:
        - name: bank_id
          in: query
          required: true
          schema:
            type: string
          example: chase
        - name: policy_type
          in: query
          required: true
          schema:
            type: string
          example: insurance
      responses:
        '200':
          description: Container information
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  container:
                    $ref: '#/components/schemas/ContainerInfo'
        '404':
          description: No active container found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/evaluate-policy:
    post:
      tags:
        - Customer API
      summary: Evaluate policy application
      description: |
        **Main endpoint for customer applications to evaluate applications using deployed rules.**

        Automatically:
        - Looks up the correct container in database
        - Routes to appropriate rule engine
        - Performs health checks
        - Logs request for analytics
        - Returns decision
      operationId: evaluatePolicy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bank_id
                - policy_type
                - applicant
              properties:
                bank_id:
                  type: string
                  description: Bank identifier
                  example: chase
                policy_type:
                  type: string
                  description: Policy type identifier
                  example: insurance
                applicant:
                  type: object
                  description: Applicant data (field names must match DRL declarations)
                  example:
                    age: 35
                    annualIncome: 75000
                    creditScore: 720
                    healthConditions: good
                    smoker: false
                policy:
                  type: object
                  description: Policy-specific data (optional, field names must match DRL)
                  example:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
            examples:
              insurance-application:
                summary: Insurance Application (Approved)
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 35
                    annualIncome: 75000
                    creditScore: 720
                    healthConditions: good
                    smoker: false
                  policy:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
              insurance-application-rejected-age:
                summary: Insurance Application (Rejected - Age)
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 70
                    annualIncome: 75000
                    creditScore: 720
                    healthConditions: good
                    smoker: false
                  policy:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
              insurance-application-rejected-credit:
                summary: Insurance Application (Rejected - Credit Score)
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 35
                    annualIncome: 75000
                    creditScore: 550
                    healthConditions: good
                    smoker: false
                  policy:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
              loan-application:
                summary: Loan Application (Approved)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 35
                    annualIncome: 85000
                    creditScore: 720
                  policy:
                    loanAmount: 150000
                    personalGuarantee: false
              loan-application-high-amount:
                summary: Loan Application (High Amount with Personal Guarantee)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 45
                    annualIncome: 250000
                    creditScore: 780
                  policy:
                    loanAmount: 2000000
                    personalGuarantee: true
              loan-application-rejected-age:
                summary: Loan Application (Rejected - Under 18)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 17
                    annualIncome: 30000
                    creditScore: 680
                  policy:
                    loanAmount: 50000
                    personalGuarantee: false
              loan-application-rejected-income:
                summary: Loan Application (Rejected - Low Income)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 28
                    annualIncome: 20000
                    creditScore: 680
                  policy:
                    loanAmount: 50000
                    personalGuarantee: false
              loan-application-rejected-credit:
                summary: Loan Application (Rejected - Credit Score)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 35
                    annualIncome: 60000
                    creditScore: 590
                  policy:
                    loanAmount: 100000
                    personalGuarantee: false
              loan-application-rejected-no-guarantee:
                summary: Loan Application (Rejected - Missing Personal Guarantee)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 40
                    annualIncome: 120000
                    creditScore: 750
                  policy:
                    loanAmount: 500000
                    personalGuarantee: false
              loan-application-rejected-amount-limit:
                summary: Loan Application (Rejected - Exceeds Maximum)
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 50
                    annualIncome: 500000
                    creditScore: 800
                  policy:
                    loanAmount: 6000000
                    personalGuarantee: true
      responses:
        '200':
          description: Decision returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvaluationResult'
        '404':
          description: No rules deployed for this bank+policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Rule container unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/evaluate-policy-hierarchical:
    post:
      tags:
        - Customer API
      summary: Evaluate policy application (Hierarchical with short-circuit)
      description: |
        **Evaluate applications using hierarchical 3-level rule engine with short-circuit behavior.**

        **How It Works:**
        1. Execute Level 1 (Critical/Knockout) rules
           - If rejected → Stop and return immediately
           - If passed → Continue to Level 2
        2. Execute Level 2 (Standard/Important) rules
           - If rejected → Stop and return immediately
           - If passed → Continue to Level 3
        3. Execute Level 3 (Preferred/Optimal) rules
           - Return final decision

        **Benefits:**
        - **Faster evaluation**: Stop immediately on rejection, no need to check all rules
        - **Clear feedback**: Know exactly which level rejected the application
        - **Prioritized rules**: Most important rules checked first

        **Response includes:**
        - `approved`: true/false
        - `reasons`: List of rejection reasons
        - `evaluation_metadata.rejection_level`: Which level rejected (1, 2, or 3)
        - `evaluation_metadata.levels_evaluated`: List of levels that were executed
        - `evaluation_metadata.short_circuit`: Whether evaluation stopped early
      operationId: evaluatePolicyHierarchical
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bank_id
                - policy_type
                - applicant
              properties:
                bank_id:
                  type: string
                  description: Bank identifier
                  example: chase
                policy_type:
                  type: string
                  description: Policy type identifier
                  example: insurance
                applicant:
                  type: object
                  description: Applicant data (field names must match DRL declarations)
                  example:
                    age: 35
                    annualIncome: 75000
                    creditScore: 720
                    healthConditions: good
                    smoker: false
                policy:
                  type: object
                  description: Policy-specific data (optional, field names must match DRL)
                  example:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
            examples:
              approved-all-levels:
                summary: Application approved (all 3 levels passed)
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 35
                    annualIncome: 75000
                    creditScore: 720
                    healthConditions: good
                    smoker: false
                  policy:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
              rejected-level1:
                summary: Rejected at Level 1 (Critical - Age)
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 17
                    annualIncome: 75000
                    creditScore: 720
                    healthConditions: good
                    smoker: false
                  policy:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
              rejected-level2:
                summary: Rejected at Level 2 (Standard - Credit Score)
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 35
                    annualIncome: 75000
                    creditScore: 550
                    healthConditions: good
                    smoker: false
                  policy:
                    coverageAmount: 500000
                    termYears: 20
                    type: term_life
      responses:
        '200':
          description: Hierarchical decision returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HierarchicalEvaluationResult'
              examples:
                approved:
                  summary: Application approved (all levels passed)
                  value:
                    status: success
                    bank_id: chase
                    policy_type: insurance
                    container_id: chase-insurance-rules
                    evaluation_mode: hierarchical
                    decision:
                      approved: true
                      reasons: []
                      requiresManualReview: false
                      premiumMultiplier: 1.0
                      evaluation_metadata:
                        levels_evaluated:
                          - level: 1
                            level_name: level1
                            description: Critical/Knockout Rules
                            kie_container_id: chase-insurance-rules-level1
                          - level: 2
                            level_name: level2
                            description: Standard/Important Rules
                            kie_container_id: chase-insurance-rules-level2
                          - level: 3
                            level_name: level3
                            description: Preferred/Optimal Rules
                            kie_container_id: chase-insurance-rules-level3
                        rejection_level: null
                        short_circuit: false
                    execution_time_ms: 125
                rejected-level1:
                  summary: Rejected at Level 1 (Critical)
                  value:
                    status: success
                    bank_id: chase
                    policy_type: insurance
                    container_id: chase-insurance-rules
                    evaluation_mode: hierarchical
                    decision:
                      approved: false
                      reasons:
                        - "Applicant age (17) is below minimum required age (18)"
                      requiresManualReview: false
                      premiumMultiplier: 1.0
                      evaluation_metadata:
                        levels_evaluated:
                          - level: 1
                            level_name: level1
                            description: Critical/Knockout Rules
                            kie_container_id: chase-insurance-rules-level1
                        rejection_level: 1
                        rejection_level_name: level1
                        short_circuit: true
                    execution_time_ms: 42
                rejected-level2:
                  summary: Rejected at Level 2 (Standard)
                  value:
                    status: success
                    bank_id: chase
                    policy_type: insurance
                    container_id: chase-insurance-rules
                    evaluation_mode: hierarchical
                    decision:
                      approved: false
                      reasons:
                        - "Credit score (550) is below minimum required (600)"
                      requiresManualReview: false
                      premiumMultiplier: 1.0
                      evaluation_metadata:
                        levels_evaluated:
                          - level: 1
                            level_name: level1
                            description: Critical/Knockout Rules
                            kie_container_id: chase-insurance-rules-level1
                          - level: 2
                            level_name: level2
                            description: Standard/Important Rules
                            kie_container_id: chase-insurance-rules-level2
                        rejection_level: 2
                        rejection_level_name: level2
                        short_circuit: true
                    execution_time_ms: 78
        '404':
          description: No rules deployed for this bank+policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Rule container unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/discovery:
    get:
      tags:
        - Customer API
      summary: Service discovery
      description: Get all banks with their available policies in one call
      operationId: serviceDiscovery
      responses:
        '200':
          description: Complete service catalog
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  services:
                    type: array
                    items:
                      type: object
                      properties:
                        bank_id:
                          type: string
                        bank_name:
                          type: string
                        available_policies:
                          type: array
                          items:
                            type: string
                        total_containers:
                          type: integer

  /api/v1/extracted-rules:
    get:
      tags:
        - Customer API
      summary: Get extracted policy rules
      description: |
        Retrieve extracted underwriting rules for a specific bank and policy type.

        **Use Case:**
        Frontend applications can display the actual underwriting rules to customers
        so they understand what criteria will be evaluated when they apply.

        **Features:**
        - Returns only active rules by default
        - Rules are grouped by category (Age Requirements, Credit Score, etc.)
        - Includes source document information
        - Timestamped for version tracking
      operationId: getExtractedRules
      parameters:
        - name: bank_id
          in: query
          required: true
          schema:
            type: string
          description: Bank identifier
          example: chase
        - name: policy_type
          in: query
          required: true
          schema:
            type: string
          description: Policy type identifier
          example: insurance
      responses:
        '200':
          description: List of extracted rules
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  bank_id:
                    type: string
                    example: chase
                  policy_type:
                    type: string
                    example: insurance
                  rule_count:
                    type: integer
                    example: 29
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExtractedRule'
              examples:
                single-level-rules:
                  summary: Single-level insurance rules (legacy)
                  value:
                    status: success
                    bank_id: chase
                    policy_type: insurance
                    hierarchical: false
                    rule_count: 3
                    rules:
                      - id: 1
                        rule_name: Minimum Age Requirement
                        requirement: Applicant must be at least 18 years old (MANDATORY - Applications under 18 are AUTOMATICALLY REJECTED)
                        category: Age Requirements
                        level: null
                        level_description: Single-level (non-hierarchical)
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-10T10:30:00"
                        is_active: true
                        created_at: "2025-11-10T10:30:00"
                        updated_at: "2025-11-10T10:30:00"
                      - id: 2
                        rule_name: Minimum Credit Score
                        requirement: Credit score must be at least 600 (MANDATORY - Applications under 600 are AUTOMATICALLY REJECTED)
                        category: Credit Score Requirements
                        level: null
                        level_description: Single-level (non-hierarchical)
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-10T10:30:00"
                        is_active: true
                        created_at: "2025-11-10T10:30:00"
                        updated_at: "2025-11-10T10:30:00"
                      - id: 3
                        rule_name: Minimum Annual Income
                        requirement: Annual income must be at least $25,000
                        category: Income Requirements
                        level: null
                        level_description: Single-level (non-hierarchical)
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-10T10:30:00"
                        is_active: true
                        created_at: "2025-11-10T10:30:00"
                        updated_at: "2025-11-10T10:30:00"
                hierarchical-rules:
                  summary: Hierarchical 3-level insurance rules
                  value:
                    status: success
                    bank_id: chase
                    policy_type: insurance
                    hierarchical: true
                    rule_count: 12
                    rules:
                      - id: 4
                        rule_name: L1 Minimum Age Requirement
                        requirement: Applicant must be at least 18 years old
                        category: Age Requirements
                        level: 1
                        level_description: Critical/Knockout Rules
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-11T14:30:00"
                        is_active: true
                        created_at: "2025-11-11T14:30:00"
                        updated_at: "2025-11-11T14:30:00"
                      - id: 5
                        rule_name: L1 Maximum Age Requirement
                        requirement: Applicant must be under 75 years old
                        category: Age Requirements
                        level: 1
                        level_description: Critical/Knockout Rules
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-11T14:30:00"
                        is_active: true
                        created_at: "2025-11-11T14:30:00"
                        updated_at: "2025-11-11T14:30:00"
                      - id: 6
                        rule_name: L2 Minimum Credit Score
                        requirement: Credit score must be at least 600
                        category: Credit Score Requirements
                        level: 2
                        level_description: Standard/Important Rules
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-11T14:30:00"
                        is_active: true
                        created_at: "2025-11-11T14:30:00"
                        updated_at: "2025-11-11T14:30:00"
                      - id: 7
                        rule_name: L2 Income to Coverage Ratio
                        requirement: Coverage amount should not exceed 20x annual income
                        category: Income Requirements
                        level: 2
                        level_description: Standard/Important Rules
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-11T14:30:00"
                        is_active: true
                        created_at: "2025-11-11T14:30:00"
                        updated_at: "2025-11-11T14:30:00"
                      - id: 8
                        rule_name: L3 Premium Discount for Non-Smokers
                        requirement: Non-smokers qualify for 10% premium discount
                        category: Premium Adjustments
                        level: 3
                        level_description: Preferred/Optimal Rules
                        source_document: sample_life_insurance_policy.txt
                        document_hash: abc123def456
                        extraction_timestamp: "2025-11-11T14:30:00"
                        is_active: true
                        created_at: "2025-11-11T14:30:00"
                        updated_at: "2025-11-11T14:30:00"
                    rules_by_level:
                      level1:
                        - id: 4
                          rule_name: L1 Minimum Age Requirement
                        - id: 5
                          rule_name: L1 Maximum Age Requirement
                      level2:
                        - id: 6
                          rule_name: L2 Minimum Credit Score
                        - id: 7
                          rule_name: L2 Income to Coverage Ratio
                      level3:
                        - id: 8
                          rule_name: L3 Premium Discount for Non-Smokers
                      single_level: []
                    level_counts:
                      level1: 2
                      level2: 2
                      level3: 1
                      single_level: 0
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: error
                message: Both bank_id and policy_type query parameters are required
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================================================
  # ADMIN API - WORKFLOW
  # ============================================================================

  /process_policy_from_s3:
    post:
      tags:
        - Admin - Workflow
      summary: Process policy document from S3 (Single-level rules)
      description: |
        **Admin endpoint:** Process a policy PDF from S3 and generate single-level rules.

        Workflow:
        1. Extract text from S3 PDF
        2. LLM analyzes and generates extraction queries
        3. AWS Textract extracts structured data
        4. LLM generates DRL rules
        4.5. Transform rules to user-friendly text using OpenAI
        5. Deploy to Drools KIE Server
        6. Upload artifacts to S3
        6.5. Register in PostgreSQL database
        7. Save extracted rules with user-friendly descriptions
      operationId: processPolicyFromS3
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - s3_url
                - policy_type
                - bank_id
              properties:
                s3_url:
                  type: string
                  format: uri
                  example: s3://bucket/policies/chase-insurance.pdf
                policy_type:
                  type: string
                  example: insurance
                bank_id:
                  type: string
                  example: chase
      responses:
        '200':
          description: Workflow completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResult'

  /process_policy_from_s3_hierarchical:
    post:
      tags:
        - Admin - Workflow
      summary: Process policy document from S3 (Hierarchical 3-level rules)
      description: |
        **Admin endpoint:** Process a policy PDF from S3 and generate hierarchical 3-level rules with short-circuit evaluation.

        **Hierarchical Rule Levels:**
        - **Level 1 (Critical/Knockout)**: Must-pass rules that immediately disqualify applications (age limits, citizenship, license validity)
        - **Level 2 (Standard/Important)**: Important risk assessment rules (income ratios, credit scores, occupation risks)
        - **Level 3 (Preferred/Optimal)**: Fine-grained adjustments (premium discounts, loyalty bonuses)

        **Short-Circuit Behavior:**
        - If Level 1 fails → Stop immediately, don't execute Level 2 or 3
        - If Level 2 fails → Stop immediately, don't execute Level 3
        - Only execute all 3 levels if each level passes

        **Workflow:**
        1. Extract text from S3 PDF
        2. LLM analyzes and generates extraction queries
        3. AWS Textract extracts structured data
        4. LLM generates 3 separate DRL files (Level 1, Level 2, Level 3)
        5. Deploy all 3 levels to ONE Docker container with 3 separate KIE containers inside:
           - `{container_id}-level1` (Critical rules)
           - `{container_id}-level2` (Standard rules)
           - `{container_id}-level3` (Preferred rules)
        6. Upload artifacts to S3
        7. Register in PostgreSQL database
        8. Save extracted rules with level information (1, 2, or 3)
      operationId: processPolicyFromS3Hierarchical
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - s3_url
                - policy_type
                - bank_id
              properties:
                s3_url:
                  type: string
                  format: uri
                  example: s3://bucket/policies/chase-insurance.pdf
                policy_type:
                  type: string
                  example: insurance
                bank_id:
                  type: string
                  example: chase
      responses:
        '200':
          description: Hierarchical workflow completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HierarchicalWorkflowResult'

  /upload_file:
      post:
        tags:
          - File Management
        summary: Upload file to S3 bucket
        description: |
          Upload any file to AWS S3 bucket with organized folder structure.
          
          **Features:**
          - Files are stored in organized folders: `{folder}/YYYY-MM-DD/filename_timestamp.ext`
          - Automatic filename sanitization and timestamping to prevent overwrites
          - Support for multiple file types (PDF, images, documents, etc.)
          - File size validation (max 100 MB)
          - Returns S3 URL for immediate access
          
          **Storage Structure:**
          - Default folder: `uploads/`
          - Date-based subfolders: `uploads/2025-11-07/`
          - Timestamped filenames: `document_20251107_143022.pdf`
          
          **Security:**
          - Filename sanitization prevents path traversal attacks
          - Folder name validation
          - Content type detection based on file extension
        operationId: uploadFile
        requestBody:
          required: true
          content:
            multipart/form-data:
              schema:
                type: object
                required:
                  - file
                properties:
                  file:
                    type: string
                    format: binary
                    description: File to upload (any file type supported)
                  folder:
                    type: string
                    description: 'S3 folder name where file will be stored (default: "uploads")'
                    example: uploads
              encoding:
                file:
                  contentType: application/octet-stream
        responses:
          '200':
            description: File uploaded successfully
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    status:
                      type: string
                      example: success
                    message:
                      type: string
                      example: File uploaded successfully to S3
                    data:
                      type: object
                      properties:
                        s3_url:
                          type: string
                          format: uri
                          description: Full S3 URL to access the uploaded file
                          example: https://uw-data-extraction.s3.us-east-1.amazonaws.com/uploads/2025-11-07/document_20251107_143022.pdf
                        s3_key:
                          type: string
                          description: S3 key (path) of the uploaded file
                          example: uploads/2025-11-07/document_20251107_143022.pdf
                        bucket:
                          type: string
                          description: S3 bucket name
                          example: uw-data-extraction
                        filename:
                          type: string
                          description: Timestamped filename stored in S3
                          example: document_20251107_143022.pdf
                        original_filename:
                          type: string
                          description: Original filename provided by user
                          example: document.pdf
                        folder:
                          type: string
                          description: Folder where file is stored
                          example: uploads
                        file_size:
                          type: integer
                          description: File size in bytes
                          example: 245760
                        content_type:
                          type: string
                          description: MIME content type
                          example: application/pdf
                examples:
                  pdf-upload:
                    summary: PDF file upload
                    value:
                      status: success
                      message: File uploaded successfully to S3
                      data:
                        s3_url: https://uw-data-extraction.s3.us-east-1.amazonaws.com/uploads/2025-11-07/policy_20251107_143022.pdf
                        s3_key: uploads/2025-11-07/policy_20251107_143022.pdf
                        bucket: uw-data-extraction
                        filename: policy_20251107_143022.pdf
                        original_filename: policy.pdf
                        folder: uploads
                        file_size: 245760
                        content_type: application/pdf
                  image-upload:
                    summary: Image file upload
                    value:
                      status: success
                      message: File uploaded successfully to S3
                      data:
                        s3_url: https://uw-data-extraction.s3.us-east-1.amazonaws.com/uploads/2025-11-07/image_20251107_143022.png
                        s3_key: uploads/2025-11-07/image_20251107_143022.png
                        bucket: uw-data-extraction
                        filename: image_20251107_143022.png
                        original_filename: screenshot.png
                        folder: uploads
                        file_size: 102400
                        content_type: image/png
          '400':
            description: Bad request (missing file, invalid folder, file too large, etc.)
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    status:
                      type: string
                      example: error
                    message:
                      type: string
                      example: No file provided. Please include a file in the "file" field.
                    error_code:
                      type: string
                      enum:
                        - MISSING_FILE
                        - EMPTY_FILENAME
                        - EMPTY_FILE
                        - FILE_TOO_LARGE
                        - INVALID_FOLDER
                      example: MISSING_FILE
                examples:
                  missing-file:
                    summary: No file provided
                    value:
                      status: error
                      message: 'No file provided. Please include a file in the "file" field.'
                      error_code: MISSING_FILE
                  file-too-large:
                    summary: File exceeds size limit
                    value:
                      status: error
                      message: 'File size (104857600 bytes) exceeds maximum allowed size (104857600 bytes)'
                      error_code: FILE_TOO_LARGE
                      file_size: 104857600
                      max_size: 104857600
          '500':
            description: Internal server error (S3 upload failed, network error, etc.)
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    status:
                      type: string
                      example: error
                    message:
                      type: string
                      example: 'S3 upload failed: AccessDenied'
                    error:
                      type: string
                      example: 'Access Denied'
                    error_code:
                      type: string
                      example: AccessDenied

  # ============================================================================
  # ADMIN API - DEPLOYMENTS
  # ============================================================================

  /api/v1/deployments:
    get:
      tags:
        - Admin - Deployments
      summary: List all deployments
      description: Query deployed rule containers with optional filters
      operationId: listDeployments
      parameters:
        - name: bank_id
          in: query
          schema:
            type: string
        - name: policy_type
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [deploying, running, stopped, failed, unhealthy]
        - name: active_only
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of deployments
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  total:
                    type: integer
                  deployments:
                    type: array
                    items:
                      $ref: '#/components/schemas/DeploymentInfo'

  /api/v1/deployments/{id}:
    get:
      tags:
        - Admin - Deployments
      summary: Get deployment details
      description: Get detailed information about a specific deployment including statistics
      operationId: getDeployment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Deployment details
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  deployment:
                    $ref: '#/components/schemas/DeploymentInfo'
                  statistics:
                    type: object
                    properties:
                      total_requests:
                        type: integer
                      successful_requests:
                        type: integer
                      failed_requests:
                        type: integer
                      avg_execution_time_ms:
                        type: number
                      success_rate:
                        type: number

  # ============================================================================
  # SYSTEM
  # ============================================================================

  /api/v1/health:
    get:
      tags:
        - System
      summary: System health check
      description: Check if database and Drools are connected
      operationId: healthCheck
      responses:
        '200':
          description: System healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                  database:
                    type: string
                    enum: [connected, disconnected]
                  drools:
                    type: string
                    enum: [connected, disconnected]
        '503':
          description: System unhealthy

components:
  schemas:
    ContainerInfo:
      type: object
      properties:
        container_id:
          type: string
          example: chase-insurance-underwriting-rules
        bank_id:
          type: string
          example: chase
        policy_type_id:
          type: string
          example: insurance
        endpoint:
          type: string
          example: http://drools-chase-insurance:8080
        status:
          type: string
          enum: [deploying, running, stopped, failed, unhealthy]
        health_status:
          type: string
          enum: [healthy, unhealthy, unknown]
        deployed_at:
          type: string
          format: date-time

    DeploymentInfo:
      type: object
      properties:
        id:
          type: integer
        container_id:
          type: string
        bank_id:
          type: string
        policy_type_id:
          type: string
        endpoint:
          type: string
        status:
          type: string
        health_status:
          type: string
        platform:
          type: string
        version:
          type: integer
        is_active:
          type: boolean
        deployed_at:
          type: string
          format: date-time
        s3_jar_url:
          type: string
        s3_drl_url:
          type: string
        s3_excel_url:
          type: string

    EvaluationResult:
      type: object
      properties:
        status:
          type: string
          example: success
        bank_id:
          type: string
        policy_type:
          type: string
        container_id:
          type: string
        decision:
          type: object
          description: Rule engine decision (format depends on deployed rules)
          example:
            approved: true
            reasons: ["Good credit score", "Stable income"]
            premium_rate: 0.85
        execution_time_ms:
          type: integer
          example: 45

    WorkflowResult:
      type: object
      properties:
        s3_url:
          type: string
        policy_type:
          type: string
        bank_id:
          type: string
        container_id:
          type: string
        status:
          type: string
          enum: [in_progress, completed, failed]
        jar_s3_url:
          type: string
        drl_s3_url:
          type: string
        excel_s3_url:
          type: string
        steps:
          type: object

    ExtractedRule:
      type: object
      properties:
        id:
          type: integer
          description: Unique rule identifier
          example: 1
        rule_name:
          type: string
          description: Name or title of the rule
          example: Minimum Age Requirement
        requirement:
          type: string
          description: The actual requirement or rule text
          example: Applicant must be at least 18 years old (MANDATORY - Applications under 18 are AUTOMATICALLY REJECTED)
        category:
          type: string
          description: Category for grouping rules
          example: Age Requirements
        level:
          type: integer
          nullable: true
          description: Hierarchical rule level (1=Critical/Knockout, 2=Standard/Important, 3=Preferred/Optimal, null=Single-level)
          example: 1
        level_description:
          type: string
          description: Human-readable description of the level (added by API, not stored in DB)
          example: Critical/Knockout Rules
        source_document:
          type: string
          description: Source document path or name from which the rule was extracted
          example: sample_life_insurance_policy.txt
        document_hash:
          type: string
          description: Hash of the source document for change detection
          example: abc123def456
        extraction_timestamp:
          type: string
          format: date-time
          description: When the rule was extracted from the document
          example: "2025-11-10T10:30:00"
        is_active:
          type: boolean
          description: Whether this rule is currently active
          example: true
        created_at:
          type: string
          format: date-time
          description: Timestamp when the record was created
          example: "2025-11-10T10:30:00"
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the record was last updated
          example: "2025-11-10T10:30:00"

    HierarchicalWorkflowResult:
      type: object
      properties:
        s3_url:
          type: string
        policy_type:
          type: string
        bank_id:
          type: string
        container_id:
          type: string
        hierarchical:
          type: boolean
          example: true
        status:
          type: string
          enum: [in_progress, completed, failed, partial]
        levels:
          type: object
          properties:
            level1:
              $ref: '#/components/schemas/LevelDeploymentInfo'
            level2:
              $ref: '#/components/schemas/LevelDeploymentInfo'
            level3:
              $ref: '#/components/schemas/LevelDeploymentInfo'
        steps:
          type: object

    LevelDeploymentInfo:
      type: object
      properties:
        kie_container_id:
          type: string
          example: chase-insurance-rules-level1
        level_description:
          type: string
          example: Critical/Knockout Rules
        status:
          type: string
          enum: [built, deployed, failed, deployment_failed]
        steps:
          type: object
          properties:
            save_drl:
              type: object
              properties:
                status:
                  type: string
                path:
                  type: string
            create_kjar:
              type: object
              properties:
                status:
                  type: string
                path:
                  type: string
            build:
              type: object
              properties:
                status:
                  type: string
                jar_path:
                  type: string
            deploy:
              type: object
              properties:
                status:
                  type: string

    HierarchicalEvaluationResult:
      type: object
      properties:
        status:
          type: string
          example: success
        bank_id:
          type: string
        policy_type:
          type: string
        container_id:
          type: string
        evaluation_mode:
          type: string
          example: hierarchical
        decision:
          $ref: '#/components/schemas/HierarchicalDecision'
        execution_time_ms:
          type: integer
          example: 125

    HierarchicalDecision:
      type: object
      properties:
        approved:
          type: boolean
          example: true
        reasons:
          type: array
          items:
            type: string
          example: []
        requiresManualReview:
          type: boolean
          example: false
        premiumMultiplier:
          type: number
          format: double
          example: 1.0
        evaluation_metadata:
          type: object
          properties:
            levels_evaluated:
              type: array
              items:
                type: object
                properties:
                  level:
                    type: integer
                    example: 1
                  level_name:
                    type: string
                    example: level1
                  description:
                    type: string
                    example: Critical/Knockout Rules
                  kie_container_id:
                    type: string
                    example: chase-insurance-rules-level1
            rejection_level:
              type: integer
              nullable: true
              description: Which level rejected the application (1, 2, 3, or null if approved)
              example: null
            rejection_level_name:
              type: string
              nullable: true
              description: Name of the level that rejected (level1, level2, level3, or null)
              example: null
            short_circuit:
              type: boolean
              description: Whether evaluation stopped early due to rejection
              example: false

    Error:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          example: No active rules deployed for bank 'chase' and policy type 'insurance'
